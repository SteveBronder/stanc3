# Based on a Dockerfile autogenerated by OCaml-Dockerfile scripts
FROM alpine:3.9

USER root

LABEL distro_style="apk"

RUN apk update && apk upgrade && \
  apk add shadow build-base bzip2 git tar curl ca-certificates openssl \
  patch rsync bash libx11-dev nano bubblewrap coreutils xz ncurses-dev m4 pcre-dev sudo

RUN useradd -m opam_ec2
#RUN usermod -aG sudo opam_ec2

RUN useradd -m opam_jenkins
#RUN usermod -aG sudo opam_jenkins

RUN echo "opam_ec2 ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
RUN echo "opam_jenkins ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers

RUN usermod -u 1000 opam_ec2
RUN usermod -u 1004 opam_jenkins

# Build ocaml and then opam from scratch
RUN git config --global user.email "docker@example.com" && \
  git config --global user.name "Docker" && \
  git clone -b 2.0 git://github.com/ocaml/opam /tmp/opam && \
  sh -c "cd /tmp/opam && make cold && mkdir -p /usr/local/bin && cp /tmp/opam/opam /usr/local/bin/opam && cp /tmp/opam/opam-installer /usr/local/bin/opam-installer && chmod a+x /usr/local/bin/opam /usr/local/bin/opam-installer && rm -rf /tmp/opam" && \
  strip /usr/local/bin/opam*

COPY ./scripts/install_build_deps.sh ./

USER opam_jenkins
RUN opam init -y --disable-sandboxing

RUN opam switch create 4.07 ocaml-base-compiler.4.07.1 && \
  opam switch 4.07

RUN bash -x install_build_deps.sh
###
USER opam_ec2
RUN opam init -y --disable-sandboxing

RUN opam switch create 4.07 ocaml-base-compiler.4.07.1 && \
  opam switch 4.07

RUN bash -x install_build_deps.sh

ENTRYPOINT [ "opam", "config", "exec", "--" ]